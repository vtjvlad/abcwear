<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABC Wear - Название товара</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {
            --primary-color: #2196F3;
            --primary-dark: #1976D2;
            --secondary-color: #4CAF50;
            --text-dark: #2C3E50;
            --text-light: #7F8C8D;
            --background-light: #F8F9FA;
            --white: #FFFFFF;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 16px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
            --border-radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            line-height: 1.6;
            background-color: var(--background-light);
            color: var(--text-dark);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: var(--white);
            padding: 20px 0;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .back-to-catalog {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--white);
            text-decoration: none;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 8px;
            transition: var(--transition);
            background: rgba(255, 255, 255, 0.1);
        }

        .back-to-catalog:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(-2px);
        }

        .back-to-catalog i {
            font-size: 16px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: var(--white);
        }

        .logo img {
            height: 40px;
        }

        .logo-text {
            font-size: 24px;
            font-weight: 700;
        }

        .header-nav {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .nav-link {
            color: var(--white);
            text-decoration: none;
            font-weight: 500;
            transition: var(--transition);
            padding: 8px 16px;
            border-radius: 8px;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .header-icons {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .icon-link {
            color: var(--white);
            font-size: 20px;
            transition: var(--transition);
        }

        .icon-link:hover {
            transform: scale(1.1);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: minmax(0, 2fr) minmax(0, 1fr);
            gap: 40px;
        }

        /* Footer */
        footer {
            background: var(--text-dark);
            color: var(--white);
            padding: 40px 0;
            margin-top: auto;
        }

        .footer-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 40px;
        }

        .footer-section h3 {
            font-size: 20px;
            margin-bottom: 20px;
            color: var(--primary-color);
        }

        .footer-links {
            list-style: none;
        }

        .footer-link {
            color: var(--text-light);
            text-decoration: none;
            margin-bottom: 10px;
            display: block;
            transition: var(--transition);
        }

        .footer-link:hover {
            color: var(--white);
            transform: translateX(5px);
        }

        .social-links {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .social-link {
            color: var(--white);
            font-size: 24px;
            transition: var(--transition);
        }

        .social-link:hover {
            color: var(--primary-color);
            transform: translateY(-3px);
        }

        /* Mobile Navigation */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            padding: 10px;
            box-shadow: var(--shadow-md);
            z-index: 1000;
        }

        .mobile-nav-links {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .mobile-nav-link {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--text-dark);
            font-size: 12px;
        }

        .mobile-nav-icon {
            font-size: 20px;
            margin-bottom: 5px;
        }

        @media (max-width: 768px) {
            .header-nav {
                display: none;
            }

            .mobile-nav {
                display: block;
            }

            .logo img {
                height: 30px;
            }

            .logo-text {
                font-size: 20px;
            }
        }

        /* Product Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: minmax(0, 2fr) minmax(0, 1fr);
            gap: 40px;
        }

        /* Product Gallery */
        .product-gallery {
            position: sticky;
            display: grid;
            grid-template-columns: 80px 1fr;
            gap: 20px;
            margin-bottom: 40px;
        }

        .thumbnail-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            height: min-content;
        }

        .thumbnail {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid #e5e5e5;
            padding: 2px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .thumbnail.active {
            border-color: var(--text-dark);
        }

        .main-image-container {
            position: relative;
        }

        .main-image-wrapper {
            position: relative;
            width: 100%;
            padding-bottom: 100%;
            background: #f5f5f5;
            border-radius: 8px;
            overflow: hidden;
        }

        .main-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .main-image.loaded {
            opacity: 1;
        }

        .image-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .image-nav.prev {
            left: 10px;
        }

        .image-nav.next {
            right: 10px;
        }

        /* Product Info */
        .product-info {
            padding-top: 20px;
        }

        /* Rating and Back Button */
        .rating-section {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .rating-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: #fff;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .back-to-catalog {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            color: var(--text-dark);
            text-decoration: none;
            font-weight: 500;
            padding: 8px 20px;
            border-radius: 30px;
            transition: var(--transition);
            background: #fff;
            border: 1px solid #e5e5e5;
            font-size: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .back-to-catalog:hover {
            border-color: var(--text-dark);
            transform: translateX(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .back-to-catalog i {
            font-size: 16px;
        }

        .product-title {
            font-size: 24px;
            font-weight: 500;
            margin-bottom: 4px;
            color: var(--text-dark);
        }

        .product-subtitle {
            font-size: 16px;
            color: var(--text-light);
            margin-bottom: 16px;
        }

        .product-price {
            display: flex;
            align-items: baseline;
            gap: 8px;
            margin-bottom: 24px;
        }

        .current-price {
            font-size: 20px;
            font-weight: 500;
        }

        .original-price {
            color: var(--text-light);
            text-decoration: line-through;
        }

        .discount {
            color: #2f7f3c;
        }

        /* Color Variants */
        .color-variants {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }

        .color-variant {
            width: 60px;
            height: 60px;
            border-radius: 6px;
            cursor: pointer;
            border: 1px solid #e5e5e5;
            padding: 2px;
            position: relative;
            overflow: hidden;
        }

        .color-variant img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
            opacity: 1;
        }

        .color-variant.selected {
            border-color: var(--text-dark);
        }

        /* Size Selector */
        .size-section {
            margin-bottom: 24px;
        }

        .size-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .size-guide-link {
            color: var(--text-dark);
            text-decoration: none;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .size-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .size-option {
            padding: 12px;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            background: #fff;
        }

        .size-option:not(.disabled):hover {
            border-color: var(--text-dark);
        }

        .size-option.disabled {
            color: var(--text-light);
            background: #f5f5f5;
            cursor: not-allowed;
            text-decoration: line-through;
        }

        .size-option.selected {
            border-color: var(--text-dark);
            font-weight: 500;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 24px;
        }

        .btn {
            width: 100%;
            padding: 18px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-primary {
            background: var(--text-dark);
            color: #fff;
        }

        .btn-primary:hover {
            background: #000;
        }

        .btn-secondary {
            background: #fff;
            border: 1px solid #e5e5e5;
            color: var(--text-dark);
        }

        .btn-secondary:hover {
            border-color: var(--text-dark);
        }

        /* Product Description */
        .product-description {
            margin-top: 32px;
            font-size: 16px;
            line-height: 1.6;
        }

        /* Mobile Styles */
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .product-gallery {
                grid-template-columns: 1fr;
            }

            .thumbnail-list {
                flex-direction: row;
                overflow-x: auto;
                padding-bottom: 8px;
            }

            .thumbnail {
                width: 60px;
                height: 60px;
            }

            .product-info {
                padding-top: 0;
            }
        }

        /* Image Loading Styles */
        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }
            100% {
                background-position: 1000px 0;
            }
        }

        .image-loader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #f0f0f0 25%, #f8f8f8 50%, #f0f0f0 75%);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite linear;
            border-radius: inherit;
            z-index: 1;
        }

        .image-wrapper {
            position: relative;
            background: #f5f5f5;
            border-radius: inherit;
            overflow: hidden;
            width: 100%;
            height: 100%;
        }

        .main-image-wrapper {
            position: relative;
            width: 100%;
            padding-bottom: 100%;
            background: #f5f5f5;
            border-radius: 8px;
            overflow: hidden;
        }

        .main-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .main-image.loaded {
            opacity: 1;
        }

        .thumbnail {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid #e5e5e5;
            padding: 2px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .thumbnail.loaded {
            opacity: 1;
        }

        .thumbnail.active {
            border-color: var(--text-dark);
        }

        /* Update existing styles */
        .thumbnail-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            height: min-content;
        }

        .main-image-container {
            position: relative;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-container">
            <a href="/" class="logo">
                <img src="/logo.png" alt="ABC Wear Logo">
                <span class="logo-text">ABC Wear</span>
            </a>
            <nav class="header-nav">
                <a href="/w" class="nav-link">Каталог</a>
                <a href="/about" class="nav-link">О нас</a>
                <a href="/contacts" class="nav-link">Контакты</a>
            </nav>
            <div class="header-icons">
                <a href="/profile" class="icon-link">
                    <i class="fa-regular fa-user"></i>
                </a>
                <a href="/favorites" class="icon-link">
                    <i class="fa-regular fa-heart"></i>
                </a>
                <a href="/cart" class="icon-link">
                    <i class="fa-solid fa-cart-shopping"></i>
                </a>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <div class="product-gallery">
                <div class="thumbnail-list" id="thumbnail-list">
                    <!-- Thumbnails will be added dynamically -->
                </div>
                <div class="main-image-container">
                    <div class="main-image-wrapper">
                        <div class="image-loader"></div>
                        <img id="main-image" src="" alt="Main Product Image" class="main-image">
                    </div>
                    <button class="image-nav prev">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="image-nav next">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <div class="product-info">
                <div class="rating-section">
                    <div class="rating-badge">
                        <i class="fas fa-star"></i>
                        Highly Rated
                    </div>
                    <a href="/w" class="back-to-catalog">
                        <i class="fas fa-arrow-left"></i>
                        <span>В каталог</span>
                    </a>
                </div>

                <h1 class="product-title" id="product-title">Загрузка...</h1>
                <p class="product-subtitle" id="product-subtitle"></p>

                <div class="product-price" id="product-price">
                    <span class="current-price"></span>
                    <span class="original-price"></span>
                    <span class="discount"></span>
                </div>

                <div class="color-variants" id="color-grid">
                    <!-- Color variants will be added dynamically -->
                </div>

                <div class="size-section">
                    <div class="size-header">
                        <h3>Select Size</h3>
                        <a href="#" class="size-guide-link">
                            <i class="fas fa-ruler"></i>
                            Size Guide
                        </a>
                    </div>
                    <div class="size-grid" id="size-grid">
                        <!-- Sizes will be added dynamically -->
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" id="add-to-cart">Add to Bag</button>
                    <button class="btn btn-secondary" id="add-to-favorites">Favorite</button>
                </div>

                <div class="product-description" id="product-description">
                    <!-- Description will be added dynamically -->
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="footer-container">
            <div class="footer-section">
                <h3>О компании</h3>
                <p>ABC Wear - ваш надежный партнер в мире моды и стиля. Мы предлагаем качественную одежду и аксессуары по доступным ценам.</p>
            </div>
            <div class="footer-section">
                <h3>Полезные ссылки</h3>
                <ul class="footer-links">
                    <li><a href="/w" class="footer-link">Каталог</a></li>
                    <li><a href="/about" class="footer-link">О нас</a></li>
                    <li><a href="/contacts" class="footer-link">Контакты</a></li>
                    <li><a href="/delivery" class="footer-link">Доставка и оплата</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>Контакты</h3>
                <ul class="footer-links">
                    <li><a href="tel:+380123456789" class="footer-link">+38 (012) 345-67-89</a></li>
                    <li><a href="mailto:info@abcwear.com" class="footer-link">info@abcwear.com</a></li>
                </ul>
                <div class="social-links">
                    <a href="#" class="social-link"><i class="fab fa-facebook"></i></a>
                    <a href="#" class="social-link"><i class="fab fa-instagram"></i></a>
                    <a href="#" class="social-link"><i class="fab fa-telegram"></i></a>
                </div>
            </div>
        </div>
    </footer>

    <nav class="mobile-nav">
        <div class="mobile-nav-links">
            <a href="/w" class="mobile-nav-link">
                <i class="fa-solid fa-store mobile-nav-icon"></i>
                <span>Каталог</span>
            </a>
            <a href="/favorites" class="mobile-nav-link">
                <i class="fa-regular fa-heart mobile-nav-icon"></i>
                <span>Избранное</span>
            </a>
            <a href="/cart" class="mobile-nav-link">
                <i class="fa-solid fa-cart-shopping mobile-nav-icon"></i>
                <span>Корзина</span>
            </a>
            <a href="/profile" class="mobile-nav-link">
                <i class="fa-regular fa-user mobile-nav-icon"></i>
                <span>Профиль</span>
            </a>
        </div>
    </nav>

    <script>
        // Get product ID from URL
        const productId = window.location.pathname.split('/').pop();
        
        // Простой обработчик для кнопки "В каталог"
        document.addEventListener('DOMContentLoaded', function() {
            const backButton = document.querySelector('.back-to-catalog');
            if (backButton) {
                backButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Back button clicked');
                    console.log('Referrer:', document.referrer);
                    
                    if (document.referrer.includes('/w')) {
                        console.log('Going back to catalog');
                        window.history.back();
                    } else {
                        console.log('Going to catalog main page');
                        window.location.href = '/w';
                    }
                });
            } else {
                console.error('Back button not found');
            }
        });

        // Кэш для хранения данных вариантов
        const variantsCache = new Map();

        // Функция для загрузки данных одного варианта
        async function loadVariantData(variantId) {
            try {
                const response = await fetch(`/api/products/${variantId}`);
                const data = await response.json();
                variantsCache.set(variantId, data);
                return data;
            } catch (error) {
                console.error(`Error loading variant ${variantId}:`, error);
                return null;
            }
        }

        // Функция для предварительной загрузки всех вариантов
        async function preloadVariants(variants) {
            console.log('Starting preload of variants:', variants.length);
            const loadPromises = variants
                .filter(variant => variant._id !== productId)
                .map(variant => {
                    console.log('Preloading variant:', variant._id);
                    return loadVariantData(variant._id);
                });
            
            try {
                await Promise.all(loadPromises);
                console.log('All variants preloaded successfully');
            } catch (error) {
                console.error('Error during variants preload:', error);
            }
        }

        // Функция для создания обертки изображения с индикатором загрузки
        function createImageWrapper(src, className, alt) {
            return `
                <div class="image-wrapper">
                    <div class="image-loader"></div>
                    <img src="${src}" 
                         alt="${alt}" 
                         class="${className}"
                         onload="this.classList.add('loaded'); this.parentElement.querySelector('.image-loader').style.display = 'none';">
                </div>
            `;
        }

        // Function to load product data
        async function loadProductData() {
            try {
                console.log('Loading initial product data:', productId);
                const response = await fetch(`/api/products/${productId}`);
                const product = await response.json();

                // Сохраняем текущий вариант в кэш
                variantsCache.set(productId, product);
                console.log('Current product cached:', productId);

                // Начинаем загрузку всех вариантов сразу
                if (product.variants && product.variants.length > 0) {
                    console.log('Starting variants preload');
                    preloadVariants(product.variants);
                }

                // Update page title
                document.title = `ABC Wear - ${product.info.name}`;

                // Update product info
                document.getElementById('product-title').textContent = product.info.name;
                document.getElementById('product-subtitle').textContent = product.info.subtitle;

                // Update price
                const priceContainer = document.getElementById('product-price');
                const currentPrice = product.price.self.UAH.currentPrice;
                const initialPrice = product.price.self.UAH.initialPrice;
                const discount = product.price.self.UAH.discount;

                priceContainer.innerHTML = `
                    <span class="current-price">${currentPrice} грн</span>
                    ${initialPrice ? `<span class="original-price">${initialPrice} грн</span>` : ''}
                    ${discount ? `<span class="discount">${discount}% off</span>` : ''}
                `;

                // Update images with loading indicators
                const thumbnailList = document.getElementById('thumbnail-list');
                const mainImageContainer = document.querySelector('.main-image-container');
                
                if (product.imageData.imgMain) {
                    // Обновляем главное изображение
                    mainImageContainer.innerHTML = `
                        <div class="main-image-wrapper">
                            <div class="image-loader"></div>
                            <img src="${product.imageData.imgMain}" 
                                 alt="Main Product Image" 
                                 class="main-image"
                                 onload="this.classList.add('loaded'); this.parentElement.querySelector('.image-loader').style.display = 'none';">
                        </div>
                        <button class="image-nav prev">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button class="image-nav next">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    `;

                    // Обновляем миниатюры
                    thumbnailList.innerHTML = `
                        <img src="${product.imageData.imgMain}" 
                             alt="Main view" 
                             class="thumbnail active"
                             onload="this.classList.add('loaded')">
                        ${product.imageData.images.map((img, index) => `
                            <img src="${img}" 
                                 alt="View ${index + 1}" 
                                 class="thumbnail"
                                 onload="this.classList.add('loaded')">
                        `).join('')}
                    `;
                }

                // Update color variants
                const colorGrid = document.getElementById('color-grid');
                if (product.variants && product.variants.length > 0) {
                    colorGrid.innerHTML = product.variants.map(variant => `
                        <div class="color-variant ${variant._id === product._id ? 'selected' : ''}" 
                             data-variant-id="${variant._id}"
                             data-url="${variant.links.url}"
                             title="${variant.info.color.name}">
                            <div class="image-wrapper">
                                <div class="image-loader"></div>
                                <img src="${variant.imageData.squarishURL}" 
                                     alt="${variant.info.color.name}"
                                     onload="this.classList.add('loaded'); this.parentElement.querySelector('.image-loader').style.display = 'none';">
                            </div>
                        </div>
                    `).join('');
                }

                // Update description
                document.getElementById('product-description').textContent = product.info.discription;

                // Add event listeners
                addEventListeners(product.variants);
            } 
            catch (error) {
                console.error('Error loading product:', error);
                document.getElementById('product-title').textContent = 'Ошибка загрузки товара';
            }
        }

        // Function to update page content
        function updatePageContent(productData) {
            document.title = `ABC Wear - ${productData.info.name}`;
            document.getElementById('product-title').textContent = productData.info.name;
            document.getElementById('product-subtitle').textContent = productData.info.subtitle;

            const priceContainer = document.getElementById('product-price');
            const currentPrice = productData.price.self.UAH.currentPrice;
            const initialPrice = productData.price.self.UAH.initialPrice;
            const discount = productData.price.self.UAH.discount;

            priceContainer.innerHTML = `
                <span class="current-price">${currentPrice} грн</span>
                ${initialPrice ? `<span class="original-price">${initialPrice} грн</span>` : ''}
                ${discount ? `<span class="discount">${discount}% off</span>` : ''}
            `;

            // Update images with loading indicators
            const thumbnailList = document.getElementById('thumbnail-list');
            const mainImageContainer = document.querySelector('.main-image-container');
            
            if (productData.imageData.imgMain) {
                // Обновляем главное изображение
                mainImageContainer.innerHTML = `
                    <div class="main-image-wrapper">
                        <div class="image-loader"></div>
                        <img src="${productData.imageData.imgMain}" 
                             alt="Main Product Image" 
                             class="main-image"
                             onload="this.classList.add('loaded'); this.parentElement.querySelector('.image-loader').style.display = 'none';">
                    </div>
                    <button class="image-nav prev">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="image-nav next">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                `;

                // Обновляем миниатюры
                thumbnailList.innerHTML = `
                    <img src="${productData.imageData.imgMain}" 
                         alt="Main view" 
                         class="thumbnail active"
                         onload="this.classList.add('loaded')">
                    ${productData.imageData.images.map((img, index) => `
                        <img src="${img}" 
                             alt="View ${index + 1}" 
                             class="thumbnail"
                             onload="this.classList.add('loaded')">
                    `).join('')}
                `;
            }

            document.getElementById('product-description').textContent = productData.info.discription;

            // Обновляем активный цвет
            const colorVariants = document.querySelectorAll('.color-variant');
            colorVariants.forEach(variant => {
                variant.classList.toggle('selected', variant.dataset.variantId === productData._id);
            });

            // Обновляем обработчики событий
            addEventListeners(productData.variants);
        }

        // Function to add event listeners
        function addEventListeners(variants) {
            // Gallery navigation
            const thumbnails = document.querySelectorAll('.thumbnail');
            const mainImage = document.querySelector('.main-image');
            const prevButton = document.querySelector('.image-nav.prev');
            const nextButton = document.querySelector('.image-nav.next');

            let currentImageIndex = 0;

            function updateImage(index) {
                const thumb = thumbnails[index];
                mainImage.src = thumb.src;
                thumbnails.forEach(t => t.classList.remove('active'));
                thumb.classList.add('active');
                currentImageIndex = index;
            }

            thumbnails.forEach((thumb, index) => {
                thumb.addEventListener('mouseenter', () => {
                    updateImage(index);
                });
            });

            prevButton.addEventListener('click', () => {
                const newIndex = (currentImageIndex - 1 + thumbnails.length) % thumbnails.length;
                updateImage(newIndex);
            });

            nextButton.addEventListener('click', () => {
                const newIndex = (currentImageIndex + 1) % thumbnails.length;
                updateImage(newIndex);
            });

            // Color variants
            const colorVariants = document.querySelectorAll('.color-variant');
            colorVariants.forEach(variant => {
                variant.addEventListener('click', async () => {
                    const variantId = variant.dataset.variantId;
                    if (!variant.classList.contains('selected')) {
                        if (variantsCache.has(variantId)) {
                            console.log('Using cached variant data:', variantId);
                            const variantData = variantsCache.get(variantId);
                            window.history.pushState({}, '', variant.dataset.url);
                            updatePageContent(variantData);
                        } else {
                            console.log('No cached data, redirecting to:', variant.dataset.url);
                            window.location.href = variant.dataset.url;
                        }
                    }
                });
            });

            // Add to cart button
            document.getElementById('add-to-cart').addEventListener('click', () => {
                const selectedSize = document.querySelector('.size-option.selected');
                if (!selectedSize) {
                    alert('Пожалуйста, выберите размер');
                    return;
                }
                // Add to cart logic here
            });

            // Add to favorites button
            document.getElementById('add-to-favorites').addEventListener('click', () => {
                // Add to favorites logic here
            });
        }

        // Load product data when page loads
        loadProductData();
    </script>
</body>
</html> 
